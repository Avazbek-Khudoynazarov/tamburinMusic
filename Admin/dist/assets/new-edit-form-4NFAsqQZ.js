import{cA as f,R as g,ah as Z,r as y,bi as _,D as s,V as v,a6 as X,F as m,W as J,T as Y,ak as K,Z as Q}from"./index-DJm73Gd8.js";import{z as d}from"./index-DXqQCM1T.js";import{t as I,F as ee}from"./form-provider-Bv2QLm_X.js";import{u as ae,F as B}from"./fields-DRFNYTBH.js";import{u as se}from"./use-params-BytqtBag.js";import{A as $,M as ie}from"./ko-DBbRYMOz.js";import"./image-DPed605N.js";import{A as r}from"./AuthService-foVeZrRB.js";import{M as oe}from"./MetaService-BYYEBCFd.js";import{C as te}from"./Card-DCic7xzO.js";import{C as ne}from"./CardHeader-qrX2o-AK.js";import{L as E}from"./LoadingButton-8OnUjDzw.js";const k={async getByType(e){try{return(await f.get(`${g.serverUrl}/manage/board/list/all?type=${e.toString()}`,{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{r.clearLocalCredential(),window.location.replace("/");return}},async getAllList(){try{return(await f.get(`${g.serverUrl}/manage/board/list/all`,{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{r.clearLocalCredential(),window.location.replace("/");return}},async getList(e){try{return(await f.get(`${g.serverUrl}/manage/board/list?page=${e.toString()}`,{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{r.clearLocalCredential(),window.location.replace("/");return}},async get(e){try{return(await f.get(`${g.serverUrl}/manage/board/get?id=${e.toString()}`,{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{r.clearLocalCredential(),window.location.replace("/");return}},async create(e){try{return(await f.post(`${g.serverUrl}/manage/board/create`,{board:e},{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{return}},async update(e){try{return(await f.put(`${g.serverUrl}/manage/board/update`,{board:e},{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{return}},async updateProfile(e,i,x,u,j){try{return(await f.put(`${g.serverUrl}/manage/board/updateProfile`,{id:e,nickName:i,cellPhone:x},{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{r.clearLocalCredential(),window.location.replace("/");return}},async delete(e){try{return(await f.delete(`${g.serverUrl}/manage/board/delete?id=${e}`,{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{r.clearLocalCredential(),window.location.replace("/");return}},async addAttachment(e){try{return(await f.post(`${g.serverUrl}/upload/data/board`,e,{headers:{Authorization:`Bearer ${r.getToken()}`,"Content-Type":"multipart/form-data"}})).data}catch(i){console.error(i);return}},async deleteAttachment(e){try{return(await f.delete(`${g.serverUrl}/upload/image?filename=${e}`,{headers:{Authorization:`Bearer ${r.getToken()}`}})).data}catch{r.clearLocalCredential(),window.location.replace("/");return}}},D=d.object({admin_id:d.number().optional(),member_id:d.number().optional(),type:d.string().min(2,{message:"게시판 종류를 선택해 주세요."}),category:d.string().optional(),subject:d.string().min(2,{message:"제목을 입력해 주세요."}),content:d.string().min(2,{message:"내용을 입력해 주세요."}),count:d.number().default(0),is_active:d.string(),is_deleted:d.string(),created_by_type:d.string(),writer_id:d.string().optional(),writer_name:d.string().optional(),created_date:d.date()}),le=D.extend({id:d.number()});function $e({currentItem:e}){const i=Z(),{type:x=""}=se(),u=x==="notice"?"공지사항":x==="faq"?"자주묻는질문":"수강후기",j=y.useMemo(()=>({id:(e==null?void 0:e.id)||0,admin_id:(e==null?void 0:e.admin_id)||1,member_id:(e==null?void 0:e.member_id)||0,type:(e==null?void 0:e.type)||(x?u:"공지사항"),category:(e==null?void 0:e.category)||(x==="faq"?"수업":""),subject:(e==null?void 0:e.subject)||"",content:(e==null?void 0:e.content)||"",count:(e==null?void 0:e.count)??0,is_active:(e==null?void 0:e.is_active)||"Y",is_deleted:(e==null?void 0:e.is_deleted)||"N",created_by_type:(e==null?void 0:e.created_by_type)||"admin",created_date:e!=null&&e.created_date?new Date(e.created_date):new Date,writer_id:(e==null?void 0:e.writer_id)||"",writer_name:(e==null?void 0:e.writer_name)||""}),[e,x,u]),S=y.useMemo(()=>e?le:D,[e]),L=ae({mode:"onSubmit",resolver:I(S),defaultValues:j}),{setValue:re,reset:C,watch:M,control:de,handleSubmit:N,formState:{isSubmitting:ce}}=L;y.useEffect(()=>{e&&C(j)},[e,j,C]),M();const[b,P]=y.useState([]),[R,O]=y.useState([]),z=y.useCallback(async()=>{O(await oe.getList("boardCategory")),e!=null&&e.id&&P(await $.getByEntity("board",e==null?void 0:e.id))},[e]);y.useEffect(()=>{z()},[z]),y.useEffect(()=>{if(b.length>0){const n={},o={};b.forEach((a,l)=>{n[l+1]=null,o[l+1]=a.file_original}),F(n),A(o)}},[b]);const T=async n=>{try{const o=Object.entries(p).filter(([t,h])=>h===null&&b[parseInt(t,10)-1]).map(([t])=>{const h=b[parseInt(t,10)-1];return $.delete(h.id)});await Promise.all(o);const a=Object.entries(p).filter(([t,h])=>{const c=b[parseInt(t,10)-1];return h!==null&&((c==null?void 0:c.file_original)!==h.name||(c==null?void 0:c.deleted))}).map(([t,h])=>{const c=new FormData;return c.append("file",h),k.addAttachment(c)}),l=await Promise.all(a);if(l.some(t=>t.filename==="")){alert("파일 업로드에 실패했습니다.");return}l.map(t=>`${g.serverUrl}/uploads/board/${t.filename}`).forEach(async(t,h)=>{var U;const c=(U=p[h+1])==null?void 0:U.name;await $.create({entity_type:"board",entity_id:n,file:t,file_original:c||"",file_size:0,created_date:new Date})})}catch(o){console.error("파일 업로드 에러:",o),alert("파일 업로드에 실패했습니다.")}},W=N(async n=>{try{let o;const{writer_id:a,writer_name:l,...w}=n;e?(o=await k.update({...w,id:e.id}),o==="success"?(e.id&&await T(e.id),_.success("게시글 정보가 수정되었습니다."),i.back()):_.error("게시글 수정에 실패했습니다.")):(o=await k.create(w),o?(await T(o.insertId),_.success("게시글 정보가 등록되었습니다."),i.back()):_.error("게시글 등록에 실패했습니다.")),C()}catch(o){console.error(o),_.error("오류가 발생했습니다. 다시 시도해주세요.")}}),H=async n=>{F(a=>({...a,[n]:null})),A(a=>({...a,[n]:"선택된 파일 없음"}));const o=b[n-1];o&&await $.delete(o.id)},q=async(n,o)=>{var l;const a=(l=o.target.files)==null?void 0:l[0];if(a){if(a.size>5242880){alert("파일 크기는 5MB 이하여야 합니다.");return}F(t=>({...t,[n]:a})),A(t=>({...t,[n]:a.name}))}},G=3,[p,F]=y.useState({1:null,2:null,3:null}),[V,A]=y.useState({1:"선택된 파일 없음",2:"선택된 파일 없음",3:"선택된 파일 없음"});return s.jsx(ee,{methods:L,onSubmit:W,children:s.jsxs(v,{spacing:{xs:3,md:5},sx:{mt:3,mx:"auto",maxWidth:{xs:720,xl:1200}},children:[s.jsxs(te,{children:[s.jsx(ne,{title:"게시글",subheader:"",sx:{mb:1}}),s.jsx(X,{}),s.jsx(v,{spacing:3,sx:{p:3},children:s.jsxs(m,{rowGap:3,columnGap:2,display:"grid",children:[s.jsx(B.Text,{name:"subject",label:"제목",sx:{gridColumn:"1 / -1"}}),((e==null?void 0:e.type)==="자주묻는질문"||x==="faq")&&s.jsx(B.Select,{name:"category",size:"medium",label:"카테고리",InputLabelProps:{shrink:!0},children:R.map(n=>s.jsx(ie,{value:n.entity_id,children:n.entity_id},n.entity_id))}),s.jsx(B.Editor,{name:"content",sx:{maxHeight:1e3,height:700}}),x==="notice"&&s.jsx(m,{sx:{width:"50%"},children:Array.from({length:G}).map((n,o)=>{var w;const a=o+1,l=b[a-1];return s.jsxs(m,{sx:{mb:2},children:[s.jsx("input",{type:"file",id:`file${a}`,style:{display:"none"},onChange:t=>{var c;((c=t.target.files)==null?void 0:c[0])&&q(a,t)}},p[a]?"hasFile":"noFile"),s.jsxs(v,{spacing:2,direction:"row",alignItems:"center",sx:{mb:2},children:[s.jsx(J,{variant:"contained",component:"label",htmlFor:`file${a}`,children:"파일 선택"}),s.jsx(Y,{sx:{flex:1},children:V[a]}),(p[a]||l)&&s.jsx(K,{onClick:()=>H(a),children:s.jsx(Q,{icon:"mdi:delete"})})]}),p[a]&&((w=p[a])!=null&&w.type.startsWith("image/"))?s.jsx(m,{sx:{mb:2},children:s.jsx("img",{src:URL.createObjectURL(p[a]),alt:"이미지 미리보기",style:{maxWidth:"200px",maxHeight:"200px"}})}):p[a]?s.jsx(m,{sx:{mb:2},children:s.jsxs("a",{href:URL.createObjectURL(p[a]),download:p[a].name,children:["다운로드 [",p[a].name,"]"]})}):null,l&&!p[a]&&s.jsx(m,{sx:{mb:2},children:l.file_original.match(/\.(jpg|jpeg|png|gif)$/i)?s.jsx("img",{src:l.file,alt:"이미지 미리보기",style:{maxWidth:"200px",maxHeight:"200px"}}):s.jsxs("a",{href:l.file,download:l.file_original,children:["다운로드 [",l.file_original,"]"]})})]},a)})})]})})]}),s.jsxs(v,{direction:"row",alignItems:"flex-end",justifyContent:"flex-end",sx:{mt:3,gap:"10px"},children:[s.jsx(E,{color:"inherit",size:"large",variant:"outlined",onClick:()=>i.back(),children:"목록으로"}),s.jsx(E,{type:"submit",variant:"contained",size:"large",children:e?"수정 완료":"등록 완료"})]})]})})}export{k as B,$e as N};
