import{cA as f,R as p,aj as Y,D as a,F as w,V as B,T as C,ah as q,r as g,bi as m,Y as U,a6 as K,W as Q,ak as I,Z as ee}from"./index-DJm73Gd8.js";import{z as h}from"./index-DXqQCM1T.js";import{t as ae,F as se}from"./form-provider-Bv2QLm_X.js";import{u as ie,F as N}from"./fields-DRFNYTBH.js";import{A as $}from"./ko-DBbRYMOz.js";import"./image-DPed605N.js";import{C as k}from"./ClassesBoardService-xI7JMK5Z.js";import{A as t}from"./AuthService-foVeZrRB.js";import{A as oe}from"./Avatar-CHZSgeuZ.js";import{T as le}from"./TextField-B_joUv90.js";import{C as R}from"./Card-DCic7xzO.js";import{C as te}from"./CardHeader-qrX2o-AK.js";import{L as P}from"./LoadingButton-8OnUjDzw.js";const re={async getByClassesBoardId(e){try{return(await f.get(`${p.serverUrl}/manage/classesBoardReply/list/all?classes_board_id=${e.toString()}`,{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}},async getAllList(){try{return(await f.get(`${p.serverUrl}/manage/classesboardreply/list/all`,{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}},async getList(e){try{return(await f.get(`${p.serverUrl}/manage/classesboardreply/list?page=${e.toString()}`,{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}},async get(e){try{return(await f.get(`${p.serverUrl}/manage/classesboardreply/get?id=${e.toString()}`,{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}},async create(e){try{return(await f.post(`${p.serverUrl}/manage/classesboardreply/create`,{classesboardreply:e},{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{return}},async update(e){try{return(await f.put(`${p.serverUrl}/manage/classesboardreply/update`,{classesboardreply:e},{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{return}},async updateProfile(e,s,y,b,v){try{return(await f.put(`${p.serverUrl}/manage/classesboardreply/updateProfile`,{id:e,nickName:s,cellPhone:y},{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}},async delete(e){try{return(await f.delete(`${p.serverUrl}/manage/classesboardreply/delete?id=${e}`,{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}},async addAttachment(e){try{return(await f.post(`${p.serverUrl}/upload/image/classesboardreply`,e,{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}},async deleteAttachment(e){try{return(await f.delete(`${p.serverUrl}/upload/image?filename=${e}`,{headers:{Authorization:`Bearer ${t.getToken()}`}})).data}catch{t.clearLocalCredential(),window.location.replace("/");return}}};function de({name:e,avatarUrl:s,message:y,tagUser:b,postedAt:v,hasReply:S}){const _=Y();return a.jsxs(w,{sx:{pt:3,display:"flex",position:"relative",...S&&{pl:8}},children:[a.jsx(oe,{alt:e,src:s,sx:{mr:2,width:48,height:48}}),a.jsxs(B,{flexGrow:1,sx:{pb:3,borderBottom:F=>`solid 1px ${F.vars.palette.divider}`},children:[a.jsx(C,{variant:"subtitle2",sx:{mb:.5},children:e}),a.jsx(C,{variant:"caption",sx:{color:"text.disabled"},children:v?new Date(v).toISOString().split("T")[0]:""}),a.jsxs(C,{variant:"body2",sx:{mt:1},children:[b&&a.jsxs(w,{component:"strong",sx:{mr:.5},children:["@",b]}),y]}),_.value&&a.jsx(w,{sx:{mt:2},children:a.jsx(le,{fullWidth:!0,autoFocus:!0,placeholder:"Write comment..."})})]})]})}function ne({comments:e=[]}){return a.jsx(a.Fragment,{children:e.map(s=>{var b;const y=s.created_date?s.created_date instanceof Date?s.created_date:new Date(s.created_date):new Date;return a.jsx(w,{children:a.jsx(de,{name:((b=s.member)==null?void 0:b.name)??"알수없음",message:s.content,postedAt:y.toISOString(),avatarUrl:""})},s.id)})})}const O=h.object({member_id:h.number(),payments_id:h.number(),classes_id:h.number(),subject:h.string(),content:h.string().optional(),is_deleted:h.string(),reply_count:h.number().default(0),viewed_date:h.date().nullable(),created_date:h.date()}),ce=O.extend({id:h.number()});function $e({currentItem:e}){const s=q(),y=g.useMemo(()=>({id:(e==null?void 0:e.id)||0,member_id:(e==null?void 0:e.member_id)||0,payments_id:(e==null?void 0:e.payments_id)||0,classes_id:(e==null?void 0:e.classes_id)||0,subject:(e==null?void 0:e.subject)||"",content:(e==null?void 0:e.content)||"",is_deleted:(e==null?void 0:e.is_deleted)||"N",reply_count:(e==null?void 0:e.reply_count)||0,viewed_date:(e!=null&&e.viewed_date,null),created_date:e!=null&&e.created_date?new Date(e.created_date):new Date,member:(e==null?void 0:e.member)||void 0,teacher:(e==null?void 0:e.teacher)||void 0,instrument:(e==null?void 0:e.instrument)||void 0,curriculum:(e==null?void 0:e.curriculum)||void 0}),[e]),b=g.useMemo(()=>e?ce:O,[e]),v=ie({mode:"onSubmit",resolver:ae(b),defaultValues:y}),{setValue:S,reset:_,watch:F,control:pe,handleSubmit:W,formState:{isSubmitting:he}}=v;g.useEffect(()=>{e&&_(y)},[e,y,_]),F();const[x,M]=g.useState([]),[T,G]=g.useState([]),z=g.useCallback(async()=>{e!=null&&e.id&&G(await re.getByClassesBoardId(e==null?void 0:e.id)),e!=null&&e.id&&M(await $.getByEntity("classesBoard",e==null?void 0:e.id))},[e]);g.useEffect(()=>{z()},[z]),g.useEffect(()=>{if(x.length>0){const r={},o={};x.forEach((i,n)=>{const u=new File([i.file],i.file_original,{type:"application/octet-stream"});r[n+1]=u,o[n+1]=i.file_original}),A(r),L(o)}},[x]);const D=async r=>{try{const o=Object.entries(j).filter(([l,c])=>c===null&&x[parseInt(l,10)-1]).map(([l])=>{const c=x[parseInt(l,10)-1];return $.delete(c.id)});await Promise.all(o);const i=Object.entries(j).filter(([l,c])=>{const d=x[parseInt(l,10)-1];return c!==null&&((d==null?void 0:d.file_original)!==c.name||(d==null?void 0:d.deleted))}).map(([l,c])=>{const d=new FormData;return d.append("file",c),k.addAttachment(d)}),n=await Promise.all(i);if(n.some(l=>l.filename==="")){alert("파일 업로드에 실패했습니다.");return}n.map(l=>`${p.serverUrl}/uploads/${l.filename}`).forEach(async(l,c)=>{var E;const d=(E=j[c+1])==null?void 0:E.name;await $.create({entity_type:"classesBoard",entity_id:r,file:l,file_original:d||"",file_size:0,created_date:new Date})})}catch(o){console.error("파일 업로드 에러:",o),alert("파일 업로드에 실패했습니다.")}},V=W(async r=>{try{let o;e?(o=await k.update({...r,id:e.id}),o==="success"?(e.id&&await D(e.id),m.success("수업 게시글 정보가 수정되었습니다."),s.push(U.classesBoard.list)):m.error("수업 게시글 수정에 실패했습니다.")):(o=await k.create({...v.getValues()}),o?(await D(o.insertId),m.success("수업 게시글 정보가 등록되었습니다."),s.push(U.classesBoard.list)):m.error("수업 게시글 등록에 실패했습니다.")),_()}catch(o){console.error(o),m.error("오류가 발생했습니다. 다시 시도해주세요.")}}),H=async r=>{A(i=>({...i,[r]:null})),L(i=>({...i,[r]:"선택된 파일 없음"}));const o=x[r-1];o&&await $.delete(o.id)},Z=async(r,o)=>{var n;const i=(n=o.target.files)==null?void 0:n[0];if(i){if(i.size>5242880){alert("파일 크기는 5MB 이하여야 합니다.");return}A(l=>({...l,[r]:i})),L(l=>({...l,[r]:i.name}))}},X=3,[j,A]=g.useState({1:null,2:null,3:null}),[J,L]=g.useState({1:"선택된 파일 없음",2:"선택된 파일 없음",3:"선택된 파일 없음"});return a.jsx(se,{methods:v,onSubmit:V,children:a.jsxs(B,{spacing:{xs:3,md:5},sx:{mt:3,mx:"auto",maxWidth:{xs:720,xl:1200}},children:[a.jsxs(R,{children:[a.jsx(te,{title:"수업 게시글",subheader:"",sx:{mb:1}}),a.jsx(K,{}),a.jsx(B,{spacing:3,sx:{p:3},children:a.jsxs(w,{rowGap:3,columnGap:2,display:"grid",children:[a.jsx(N.Text,{name:"subject",label:"제목",sx:{gridColumn:"1 / -1"}}),a.jsx(N.Editor,{name:"content",sx:{maxHeight:1e3,height:700}}),a.jsx(w,{sx:{width:"50%"},children:Array.from({length:X}).map((r,o)=>{var n,u;const i=o+1;return a.jsxs(w,{sx:{mb:2},children:[a.jsx("input",{type:"file",id:`file${i}`,style:{display:"none"},onChange:l=>{var d;((d=l.target.files)==null?void 0:d[0])&&Z(i,l)}},j[i]?"hasFile":"noFile"),a.jsxs(B,{spacing:2,direction:"row",alignItems:"center",sx:{mb:2},children:[a.jsx(Q,{variant:"contained",component:"label",htmlFor:`file${i}`,children:"파일 선택"}),a.jsx(C,{sx:{flex:1},children:J[i]}),j[i]&&a.jsx(I,{onClick:()=>H(i),children:a.jsx(ee,{icon:"mdi:delete"})})]}),(n=j[i])!=null&&n.type.startsWith("image/")?a.jsx(w,{sx:{mb:2},children:a.jsx("img",{src:URL.createObjectURL(j[i]),alt:"이미지 미리보기",style:{maxWidth:"200px",maxHeight:"200px"}})}):j[i]&&((u=x[i-1])==null?void 0:u.file)&&a.jsx(w,{sx:{mb:2},children:a.jsxs("a",{href:x[i-1].file,download:!0,children:["다운로드 [",x[i-1].file_original,"]"]})})]},i)})})]})})]}),T.length>0&&a.jsx(R,{sx:{p:"10px 30px"},children:a.jsx(ne,{comments:T})}),a.jsxs(B,{direction:"row",alignItems:"flex-end",justifyContent:"flex-end",sx:{mt:3,gap:"10px"},children:[a.jsx(P,{color:"inherit",size:"large",variant:"outlined",onClick:()=>s.back(),children:"목록으로"}),a.jsx(P,{type:"submit",variant:"contained",size:"large",children:e?"수정 완료":"등록 완료"})]})]})})}export{$e as N};
